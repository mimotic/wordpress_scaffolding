# =============================================================================
# SECURITY RULES
# =============================================================================

# -----------------------------------------------------------------------------
# Let's Encrypt / ACME Challenge - MUST be before other dot-file blocks
# -----------------------------------------------------------------------------
location ^~ /.well-known/acme-challenge/ {
    allow all;
    default_type "text/plain";
}

# -----------------------------------------------------------------------------
# Block author enumeration (?author=1, ?author=2, etc.)
# Prevents username discovery via author archives
# -----------------------------------------------------------------------------
if ($args ~* "^author=\d") {
    return 403;
}

# -----------------------------------------------------------------------------
# HTTP Parameter Pollution Protection
# Blocks duplicate parameters in query string
# -----------------------------------------------------------------------------
if ($args ~* "(^|&)([^=]+)=.*&\2=") {
    return 400;
}

# -----------------------------------------------------------------------------
# Block malicious User-Agents
# Common scanners, bots and exploit tools
# -----------------------------------------------------------------------------
if ($http_user_agent ~* (
    wpscan|
    libwww-perl|
    Wget|
    curl/|
    python-requests|
    Go-http-client|
    sqlmap|
    nikto|
    nmap|
    masscan|
    ZmEu|
    Morfeus|
    DirBuster|
    Havij|
    w3af|
    Acunetix|
    Netsparker|
    AppScan|
    WebInspect|
    Arachni
)) {
    return 403;
}

# -----------------------------------------------------------------------------
# Block suspicious request methods
# Only allow standard methods
# -----------------------------------------------------------------------------
if ($request_method !~ ^(GET|HEAD|POST|PUT|PATCH|DELETE|OPTIONS)$) {
    return 405;
}

# -----------------------------------------------------------------------------
# Block requests with empty User-Agent
# Most legitimate browsers send User-Agent
# -----------------------------------------------------------------------------
if ($http_user_agent = "") {
    return 403;
}

# -----------------------------------------------------------------------------
# Block access to hidden files (except .well-known)
# Protects .git, .env, .htaccess, etc.
# -----------------------------------------------------------------------------
location ~ /\.(?!well-known) {
    deny all;
    access_log off;
    log_not_found off;
}

# -----------------------------------------------------------------------------
# Block access to sensitive files
# -----------------------------------------------------------------------------
location ~* /(\.env|\.git|\.svn|\.hg|composer\.(json|lock)|package\.(json|lock)|yarn\.lock|Gruntfile|Gulpfile|webpack\.config) {
    deny all;
    access_log off;
    log_not_found off;
}

# -----------------------------------------------------------------------------
# Limit request body size (protect against large payload attacks)
# Adjust if you need larger uploads
# -----------------------------------------------------------------------------
# client_max_body_size 64M;

# -----------------------------------------------------------------------------
# Rate limiting zone (define in http block, use in location blocks)
# Example: limit_req zone=one burst=10 nodelay;
# -----------------------------------------------------------------------------
# limit_req_zone $binary_remote_addr zone=one:10m rate=10r/s;
